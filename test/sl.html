<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>sl</title>
    <style type="text/css">
    .tab_out {
        text-align: center;
    }

    .tab td {
        width: 10px;
        height: 10px;
        border: 1px solid #eee;
        position: relative;
        color: #aaa;
        font-size: 10px;
        overflow: hidden;
        text-align: center;
        line-height: 10px;
        cursor: pointer;
    }

    .tab img {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0px;
        left: 0px;
    }
    </style>
</head>

<body>
    <div class="top">
        size:<input type="text" value="10" id="mapSize" />
        <br />
        num:<input type="text" value="10" id="bombNum" />
        <br />
        <button id="giveUp">give up</button>
    </div>
    <div class="tab_out">
        <table id="tab" class="tab">
        </table>
    </div>
    <script src="./jquery-1.7.1.min.js"></script>
    <script type="text/javascript">
    $(function() {
        var self = this;

        // 地图尺寸
        var mapSize = 0;

        // 雷数
        var bombNum = 0;

        // 地图-正确 -1空 0雷 数
        var arrMap = new Array();

        // 地图-游戏 -4未 -3旗 -2问 -1空 0雷 数
        var arrGame = new Array();

        // 事件绑定
        this.createEventer = function() {
            // 左键点击网格
            $(this).delegate('#tab td', 'click', function() {
                var x = parseInt($("#tab td").index(this) / self.mapSize);
                var y = parseInt($("#tab td").index(this) % self.mapSize);

                if (arrMap[x][y] > 0) {
                    $(this).html(arrMap[x][y]);
                } else if (arrMap[x][y] == 0) {
                    alert('555');
                    self.gameEnd();
                } else {
                    // 空 ???
                }

            });







            document.oncontextmenu = function(e) {
                return false;
            }

            // $('#tab td').mousedown(function(e) {
            //     if (3 == e.which) {
            //         console.log('这是右键单击事件');
            //     } else if (1 == e.which) {
            //         console.log('这是左键单击事件');
            //     } else {
            //         return false;
            //     }
            // })

            document.getElementById('#tab').onmousedown = function(e) {

                switch (e.button) {
                    case 0:
                        console.log("鼠标左键")
                        break;
                    case 2:
                        console.log("鼠标右键");
                        break;
                    default:
                        break;
                }
            }
















            // 放弃游戏
            $(this).delegate('#giveUp', 'click', function() {
                if (confirm("gu?")) {
                    self.gameEnd();
                }
            });
        }

        // 游戏结束
        this.gameEnd = function() {
            // 结束 ???
        }

        // 获取设置参数
        this.getSet = function() {
            self.mapSize = parseInt($('#mapSize').val());
            self.bombNum = parseInt($('#bombNum').val());
        }

        // 初始化网格
        this.initTab = function() {
            var html_tab = '';
            for (var i = 0; i < self.mapSize; i++) {
                html_tab += '<tr>';
                for (var j = 0; j < self.mapSize; j++) {
                    html_tab += '<td></td>';
                }
                html_tab += '</tr>';
            }
            $('#tab').html(html_tab);
        }

        // 初始化数组
        this.initArr = function() {
            for (var i = 0; i < self.mapSize; i++) {
                arrMap[i] = new Array();
                arrGame[i] = new Array();
                for (var j = 0; j < self.mapSize; j++) {
                    arrMap[i][j] = -1;
                    arrGame[i][j] = -4;
                }
            }
        }

        // 初始化雷的位置
        this.initBomb = function() {
            var tempNum = 0;
            var x = 0;
            var y = 0;
            while (tempNum < self.bombNum + 1) {
                x = self.randomNum(0, self.mapSize);
                y = self.randomNum(0, self.mapSize);
                if (arrMap[x][y] == -1) {
                    arrMap[x][y] = 0;
                    tempNum++;
                }
            }
        }

        // 初始化数字位置
        this.initNum = function() {
            for (var i = 0; i < self.mapSize; i++) {
                for (var j = 0; j < self.mapSize; j++) {
                    if (arrMap[i][j] == -1) {
                        arrMap[i][j] = self.calcNum(i, j);
                    }
                }
            }
        }

        // 根据坐标计算周边雷数
        this.calcNum = function(x, y) {
            var tempNum = 0;

            if (x >= 1 && y >= 1 && arrMap[x - 1][y - 1] == 0) {
                tempNum++;
            }

            if (x >= 1 && arrMap[x - 1][y] == 0) {
                tempNum++;
            }

            if (x >= 1 && y + 1 < self.mapSize && arrMap[x - 1][y + 1] == 0) {
                tempNum++;
            }

            if (y >= 1 && arrMap[x][y - 1] == 0) {
                tempNum++;
            }

            if (y + 1 < self.mapSize && arrMap[x][y + 1] == 0) {
                tempNum++;
            }

            if (x + 1 < self.mapSize && y >= 1 && arrMap[x + 1][y - 1] == 0) {
                tempNum++;
            }

            if (x + 1 < self.mapSize && arrMap[x + 1][y] == 0) {
                tempNum++;
            }

            if (x + 1 < self.mapSize && y + 1 < self.mapSize && arrMap[x + 1][y + 1] == 0) {
                tempNum++;
            }

            return tempNum == 0 ? -1 : tempNum;
        }

        // 随机整数 包括m不包括n
        this.randomNum = function(m, n) {
            var random = Math.floor(Math.random() * (m - n) + n);
            return random;
        }

        // 初始化
        this.init = function() {
            // 事件绑定
            self.createEventer();

            // 获取设置参数
            self.getSet();

            // 初始化数组
            self.initArr();

            // 初始化雷的位置
            self.initBomb();

            // 初始化数字位置
            self.initNum();

            // 初始化页面网格
            self.initTab();






            // for (var i = 0; i < self.mapSize; i++) {
            //     var str = "";
            //     for (var j = 0; j < self.mapSize; j++) {
            //         str += arrMap[i][j] + ' ';
            //     }
            //     console.log(str);
            // }
            // console.log('+++++++++++');
            // for (var i = 0; i < self.mapSize; i++) {
            //     var str = "";
            //     for (var j = 0; j < self.mapSize; j++) {
            //         str += arrGame[i][j]+' ';
            //     }
            //     console.log(str);
            // }





        }

        self.init();
    })
    </script>
</body>

</html>